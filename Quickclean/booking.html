<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QuickClean â€” Book a Cleaning (single-file)</title>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;800&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
/* ---------- QuickClean Booking Page (inline CSS) ---------- */

/* CSS variables (brand colors + spacing) */
:root{
  --brand-blue: #66B7F0;
  --nav-yellow: #FFDB58;
  --cta-yellow: #FFD54A;
  --text-blue: #2E89F0;
  --bg: #f6f8fa;
  --muted: #6b7b8c;
  --card: #ffffff;
  --max-w: 1200px;
  --gap: 16px;
  --radius: 10px;
}

/* Reset & base */
*{ box-sizing: border-box; }
html,body{ height: 100%; }
body{
  margin:0;
  font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  background: var(--bg);
  color: #0f2a3a;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  line-height:1.4;
}

/* Container helper */
.container{ max-width: var(--max-w); margin: 0 auto; padding: 20px; }

/* Header */
.qc-header{
  background: var(--brand-blue);
  color: #fff;
  position: sticky;
  top:0;
  z-index: 1000;
  box-shadow: 0 1px 0 rgba(0,0,0,0.04);
}
.qc-header-inner{
  max-width: var(--max-w);
  margin: 0 auto;
  display:flex;
  align-items:center;
  gap: 12px;
  padding: 12px 20px;
}
.qc-logo{ width:56px; height:56px; object-fit:cover; border-radius:8px; border:3px solid rgba(255,255,255,0.2); }
.qc-tagline{ font-family:"Baloo 2", sans-serif; font-weight:700; font-size:18px; text-align:center; flex:1;}
.qc-profile{ width:46px; height:46px; border-radius:50%; object-fit:cover; border: 3px solid rgba(255,255,255,0.2); }

/* Nav band */
.qc-nav{ background: var(--nav-yellow); box-shadow:0 1px 0 rgba(0,0,0,0.06); }
.qc-nav ul{ max-width: var(--max-w); margin:0 auto; padding:8px 20px; display:flex; gap:18px; list-style:none; align-items:center; justify-content:center; flex-wrap:wrap; }
.qc-nav a{ color: var(--text-blue); font-weight:700; text-decoration:none; padding:6px 8px; }
.qc-nav a.active{ text-decoration: underline; text-underline-offset:6px; }

/* Buttons */
.btn{ border:0; background: var(--text-blue); color:#fff; padding:8px 12px; border-radius:8px; font-weight:700; cursor:pointer; }
.btn.ghost{ background:transparent; color:var(--text-blue); border:1px solid rgba(0,0,0,0.06); }
.btn.small{ padding:6px 8px; font-size:13px; }
.btn.primary{ background: var(--cta-yellow); color: #144c7a; font-weight:800; }
.btn.pill{ border-radius:999px; }
.btn.full{ width:100%; }

/* Hero */
.booking-hero{ display:flex; gap:24px; align-items:center; padding:36px 20px; max-width: var(--max-w); margin:0 auto; }
.hero-content{ flex:1; min-width: 260px; }
.hero-title{ font-family:"Baloo 2", sans-serif; color: var(--text-blue); font-size: 40px; margin: 0 0 8px; }
.hero-sub{ color:var(--muted); margin:0 0 18px; }
.hero-image img{ width:420px; max-width:40vw; border-radius: var(--radius); object-fit:cover; }

/* Booking area layout */
.booking-area{ display:flex; gap:24px; align-items:flex-start; max-width: var(--max-w); margin: 18px auto; padding: 0 20px 40px; }
.booking-form-col{ flex: 0 0 55%; min-width: 280px; }
.booking-summary-col{ flex: 0 0 45%; min-width: 260px; }

/* Form controls */
.booking-form fieldset{ border:0; padding:0; margin:0; display:flex; flex-direction:column; gap:12px; }
.booking-form label{ font-weight:700; font-size:14px; }
.booking-form select, .booking-form input[type="text"], .booking-form input[type="email"], .booking-form input[type="tel"], .booking-form textarea, .booking-form input[type="date"]{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:1px solid #dfe6ee;
  font-size:14px;
  background:#fff;
}

/* utility grid */
.grid-2{ display:flex; gap:12px; }
.grid-2 > *{ flex:1; }

/* extras */
.extras-list{ display:flex; flex-direction:column; gap:6px; }
.extras-list label{ display:flex; align-items:center; gap:8px; font-weight:500; }

/* timeslots (radio-like buttons) */
.timeslots{ display:flex; gap:8px; flex-wrap:wrap; padding:8px 0; }
.timeslot{
  padding:8px 10px; border-radius:8px; border:1px solid #e6eef6; background:#fff; cursor:pointer;
  min-width:72px; text-align:center;
}
.timeslot[aria-checked="true"]{ border-color: var(--text-blue); box-shadow:0 6px 14px rgba(14,70,140,0.06); background: linear-gradient(180deg,#fff,#f8fbff); }
.timeslot[aria-disabled="true"]{ opacity:0.45; cursor:not-allowed; }

/* summary card */
.card{ background: var(--card); border-radius: var(--radius); padding:14px; box-shadow: 0 12px 24px rgba(16,41,71,0.06); }
.summary-card h2{ margin:0 0 8px 0; color:var(--text-blue); font-family:"Baloo 2"; }
.summary-block{ font-size:14px; color:var(--muted); margin-bottom:8px; }
.price-block{ margin-top:12px; }
.price-line{ display:flex; justify-content:space-between; padding:6px 0; color:#123; }
.price-line.total{ font-size:18px; font-weight:800; }

/* small text + hints */
.field-hint{ font-size:13px; color:var(--muted); margin-top:4px; }
.terms-row{ display:flex; gap:8px; align-items:center; margin-top:6px; }
.form-actions{ display:flex; gap:12px; align-items:center; margin-top:8px; flex-wrap:wrap; }
.form-errors{ margin-top:8px; color:#b21b1b; font-weight:700; }

/* modal */
.confirm-modal{
  position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:1600;
}
.confirm-modal[hidden]{ display:none; }
.modal-backdrop{ position:absolute; inset:0; background:rgba(2,6,23,0.6); }
.modal-panel{ position:relative; width:min(840px,96%); z-index:2; }
.modal-close{
  position:absolute; right:8px; top:8px; background:#fff; border:1px solid rgba(0,0,0,0.06); width:36px; height:36px; border-radius:8px; font-size:18px; cursor:pointer;
}

/* accessibility helpers */
.sr-only{ position:absolute!important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; white-space:nowrap; }
:focus{ outline:3px solid rgba(46,137,240,0.18); outline-offset:3px; }

/* responsive */
@media (max-width:1024px){
  .booking-hero{ flex-direction:column; align-items:flex-start; }
  .booking-area{ flex-direction:column; }
  .booking-form-col,.booking-summary-col{ flex:1 1 100%; }
  .hero-image img{ max-width:100%; height:auto; }
}
@media (max-width:768px){
  .grid-2{ flex-direction:column; }
  .hero-title{ font-size:32px; }
}

/* respects reduced-motion */
@media (prefers-reduced-motion: reduce){
  *{ transition:none!important; }
}
</style>
</head>

<body>
  <!-- Header & Nav -->
  <header class="qc-header" role="banner">
    <div class="qc-header-inner">
      <img src="assets/booking/logo.png" alt="QuickClean logo" class="qc-logo">
      <div class="qc-tagline">QuickClean: Clean Spaces, Happy Faces.</div>
      <img src="Profile Icon.jpg" alt="Profile" class="qc-profile">
    </div>

    <nav class="qc-nav" role="navigation" aria-label="Main navigation">
      <ul>
        <li><a href="#" class="active">Home</a></li>
        <!-- Services now points to the services area of the booking form -->
        <li><a href="#services" id="navServices">Services</a></li>
        <li><a href="#">Testimonies</a></li>
        <li><a href="#">About Us</a></li>
        <li><a href="#booking" id="jumpBooking">Contact Us</a></li>
      </ul>
    </nav>
  </header>

  <!-- Main -->
  <main id="booking-main" class="booking-main" role="main">
    <!-- Hero -->
    <section class="booking-hero container" aria-labelledby="heroTitle">
      <div class="hero-content">
        <h1 id="heroTitle" class="hero-title">Book a Cleaning</h1>
        <p class="hero-sub">Pick a service, choose a date & time, and we'll send a cleaner.</p>
        <button id="startBooking" class="btn primary pill">Start booking</button>
      </div>
      <div class="hero-image" aria-hidden="true">
        <img src="Cleaner Image.jpg" alt="Two cleaners happy after cleaning" />
      </div>
    </section>

    <!-- Booking area -->
    <section class="booking-area container" id="booking" aria-labelledby="bookingHeading">
      <div class="booking-form-col">
        <form id="bookingForm" class="booking-form" novalidate aria-describedby="formErrors" >
          <fieldset>
            <legend class="sr-only">Booking form</legend>

            <!-- Anchor target for Services nav -->
            <div id="services" aria-hidden="false" class="sr-only">Services section anchor</div>

            <label for="service">Service <span aria-hidden="true">*</span></label>
            <select id="service" name="service" required aria-required="true" aria-describedby="serviceDesc"></select>
            <div id="serviceDesc" class="field-hint">Select the service you want us to provide.</div>

            <div class="grid-2">
              <div>
                <label for="bedrooms">Bedrooms</label>
                <select id="bedrooms" name="bedrooms" aria-label="Bedrooms">
                  <option value="0">Studio / 0</option>
                  <option value="1">1</option>
                  <option value="2" selected>2</option>
                  <option value="3">3</option>
                  <option value="4">4+</option>
                </select>
              </div>
              <div>
                <label for="bathrooms">Bathrooms</label>
                <select id="bathrooms" name="bathrooms" aria-label="Bathrooms">
                  <option value="1">1</option>
                  <option value="2" selected>2</option>
                  <option value="3">3</option>
                </select>
              </div>
            </div>

            <fieldset aria-labelledby="extrasLegend">
              <legend id="extrasLegend">Optional extras</legend>
              <div id="extrasList" class="extras-list" aria-describedby="extrasDesc"></div>
              <div id="extrasDesc" class="field-hint">Extras add time and cost; select any that apply.</div>
            </fieldset>

            <label for="date">Preferred date <span aria-hidden="true">*</span></label>
            <input id="date" name="date" type="date" required aria-required="true" aria-describedby="dateHint">
            <div id="dateHint" class="field-hint">Select a date (not in the past).</div>

            <label id="timeslotLabel">Preferred time slot <span aria-hidden="true">*</span></label>
            <div id="timeslots" class="timeslots" role="radiogroup" aria-labelledby="timeslotLabel" tabindex="0" aria-describedby="timeslotHint"></div>
            <div id="timeslotHint" class="field-hint">Choose an available slot. Unavailable slots are disabled.</div>

            <label for="address">Address <span aria-hidden="true">*</span></label>
            <textarea id="address" name="address" rows="3" required aria-required="true" placeholder="Street, unit, barangay"></textarea>

            <div class="grid-2">
              <div>
                <label for="name">Full name <span aria-hidden="true">*</span></label>
                <input id="name" name="name" type="text" required>
              </div>
              <div>
                <label for="phone">Phone <span aria-hidden="true">*</span></label>
                <input id="phone" name="phone" type="tel" inputmode="tel" placeholder="+63 912 345 6789" required aria-describedby="phoneHint">
                <div id="phoneHint" class="field-hint">Include country code. Example: +63 9xxxxxxxxx</div>
              </div>
            </div>

            <label for="email">Email (optional)</label>
            <input id="email" name="email" type="email" placeholder="you@example.com">

            <label for="notes">Special requests</label>
            <textarea id="notes" name="notes" rows="3" placeholder="Allergies, access notes, pets"></textarea>

            <label for="promo">Promo code</label>
            <div class="promo-row" style="display:flex;gap:8px;">
              <input id="promo" name="promo" type="text" placeholder="Enter promo code" aria-describedby="promoMsg">
              <button type="button" id="applyPromo" class="btn ghost small">Apply</button>
            </div>
            <div id="promoMsg" class="field-hint" role="status" aria-live="polite"></div>

            <div class="terms-row">
              <input id="terms" name="terms" type="checkbox" required aria-required="true">
              <label for="terms">I agree to terms and policies <span aria-hidden="true">*</span></label>
            </div>

            <div class="form-actions">
              <button id="confirmBooking" class="btn primary pill" type="submit" disabled>Confirm Booking</button>
              <button id="resetDemo" type="button" class="btn ghost">Reset demo</button>
            </div>

            <div id="formErrors" class="form-errors" role="alert" aria-live="assertive"></div>
          </fieldset>
        </form>
      </div>

      <!-- Summary column -->
      <aside class="booking-summary-col" aria-labelledby="summaryHeading">
        <div class="summary-card card" role="complementary">
          <h2 id="summaryHeading">Booking summary</h2>
          <div class="summary-block">
            <div><strong>Service:</strong> <span id="sumService">â€”</span></div>
            <div><strong>Extras:</strong> <span id="sumExtras">â€”</span></div>
            <div><strong>Date & time:</strong> <span id="sumDate">â€”</span></div>
            <div><strong>Duration:</strong> <span id="sumDuration">â€”</span></div>
            <div style="margin-top:6px;"><strong>Address:</strong><div id="sumAddress" class="field-hint">â€”</div></div>
          </div>

          <hr>

          <div class="price-block">
            <div class="price-line"><span>Service</span><span id="priceService">â‚±0</span></div>
            <div class="price-line"><span>Extras</span><span id="priceExtras">â‚±0</span></div>
            <div class="price-line"><span>Rooms adj.</span><span id="priceRooms">â‚±0</span></div>
            <div class="price-line"><span>Tax (12%)</span><span id="priceTax">â‚±0</span></div>
            <div class="price-line discount"><span>Promo</span><span id="pricePromo">-â‚±0</span></div>
            <div class="price-line total"><strong>Total</strong><strong id="priceTotal">â‚±0</strong></div>
          </div>

          <div style="margin-top:12px;">
            <button id="bookNow" class="btn primary full" disabled>Book now</button>
          </div>

          <div id="availabilityBar" class="availability" aria-hidden="false" style="margin-top:12px;">
            <small class="field-hint">Selected date availability</small>
            <div id="availText" class="field-hint">No date selected</div>
          </div>

          <div class="field-hint" style="margin-top:10px;">
            <small>Demo only â€” your personal data stays in your browser (localStorage) and is not sent anywhere.</small>
          </div>
        </div>
      </aside>
    </section>
  </main>

  <!-- Confirmation modal -->
  <div id="confirmModal" class="confirm-modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle" hidden>
    <div class="modal-backdrop" id="confirmBackdrop" data-dismiss></div>
    <div class="modal-panel" role="document">
      <button id="closeConfirm" class="modal-close" aria-label="Close confirmation">&times;</button>
      <div class="modal-body card" role="status">
        <h2 id="confirmTitle">Booking confirmed</h2>
        <p id="confirmMsg">Thank you â€” your booking <strong id="confirmId"></strong> was saved to your browser.</p>
        <div id="confirmSummary"></div>
        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
          <button id="downloadIcs" class="btn">Add to calendar (.ics)</button>
          <button id="printConfirm" class="btn ghost">Print</button>
          <button id="closeConfirm2" class="btn ghost">Close</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ---------- booking-single.html JS (inline) ----------
   Changes: Nav Services now scrolls/focuses the service selector.
   All other logic unchanged from the single-file booking implementation.
*/

/* ---------- Helpers & constants ---------- */
const $ = (sel, ctx=document) => ctx.querySelector(sel);
const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));

const LS_BOOKINGS = 'qc_bookings_v1';
const LS_SEEDED  = 'qc_bookings_seeded_v1';

/* Services & extras dataset (demo) */
const SERVICES = [
  { id:'deep', name:'Deep Cleaning', durMins:210, price:3200 },
  { id:'regular', name:'Regular Cleaning', durMins:120, price:1800 },
  { id:'post', name:'Post-Construction', durMins:300, price:4200 },
  { id:'move', name:'Move-in/Move-out', durMins:300, price:4500 },
  { id:'upholstery', name:'Upholstery Cleaning', durMins:60, price:900 }
];

const EXTRAS = [
  { id:'fridge', name:'Inside fridge', mins:20, price:250 },
  { id:'oven', name:'Inside oven', mins:30, price:300 },
  { id:'windows', name:'Window cleaning (interior)', mins:45, price:450 },
  { id:'laundry', name:'Laundry', mins:30, price:350 }
];

const PROMOS = {
  'SAVE10': { type:'pct', value:10 },
  'TAKE50': { type:'flat', value:50 }
};

/* Working hours for demo timeslots */
const WORK_START = 8;  // 08:00
const WORK_END   = 17; // 17:00

/* ---------- Storage helpers ---------- */
function seededCheck(){
  return !!localStorage.getItem(LS_SEEDED);
}
function seedDemoBookings(){
  if (seededCheck()) return;
  // sample bookings to create conflicts on 2025-09-20 for testing
  const seed = [
    { id:'BK-1001', serviceId:'regular', serviceName:'Regular Cleaning', date:'2025-09-20', time:'09:00', durMins:120, name:'Anna Santos', phone:'+639129990001', address:'Unit 12, Dream Tower', price:1800, created: new Date().toISOString(), status:'pending' },
    { id:'BK-1002', serviceId:'upholstery', serviceName:'Upholstery Cleaning', date:'2025-09-20', time:'11:00', durMins:60, name:'Peter Lim', phone:'+639172223333', address:'House 5, Green St', price:900, created: new Date().toISOString(), status:'pending' }
  ];
  localStorage.setItem(LS_BOOKINGS, JSON.stringify(seed));
  localStorage.setItem(LS_SEEDED, '1');
}
function getBookings(){
  try {
    return JSON.parse(localStorage.getItem(LS_BOOKINGS) || '[]');
  } catch(e){
    return [];
  }
}
function saveBookings(list){
  localStorage.setItem(LS_BOOKINGS, JSON.stringify(list || []));
}

/* ---------- Utility conversions ---------- */
function hhmmToMins(hhmm){
  const [h,m] = hhmm.split(':').map(Number);
  return h*60 + (m||0);
}
function minsToHhmm(mins){
  const h = Math.floor(mins/60), m = mins%60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
}
function todayISO(){
  return new Date().toISOString().slice(0,10);
}

/* ---------- Populate UI: services, extras ---------- */
function populateServices(){
  const sel = $('#service');
  sel.innerHTML = '';
  SERVICES.forEach(s => {
    const o = document.createElement('option');
    o.value = s.id;
    o.textContent = `${s.name} (${Math.round(s.durMins/60)}-${Math.ceil(s.durMins/60)} hrs)`;
    sel.appendChild(o);
  });
  // initial desc
  $('#serviceDesc').textContent = SERVICES[0].name;
}
function populateExtras(){
  const root = $('#extrasList');
  root.innerHTML = '';
  EXTRAS.forEach(x => {
    const id = `extra-${x.id}`;
    const label = document.createElement('label');
    label.innerHTML = `<input type="checkbox" id="${id}" data-extra="${x.id}"> ${x.name} (+â‚±${x.price})`;
    root.appendChild(label);
  });
}

/* ---------- Timeslot generation & rendering ---------- */
function generateSlots(durMins, slotStep=60){
  const slots = [];
  const start = WORK_START*60;
  const end = WORK_END*60 - durMins + 1;
  for (let t = start; t <= end; t += slotStep) slots.push(minsToHhmm(t));
  return slots;
}
function overlap(dateA, timeA, durA, dateB, timeB, durB){
  if (dateA !== dateB) return false;
  const s1 = hhmmToMins(timeA), e1 = s1 + durA;
  const s2 = hhmmToMins(timeB), e2 = s2 + durB;
  return Math.max(s1,s2) < Math.min(e1,e2);
}
function renderTimeslots(){
  const date = $('#date').value;
  const root = $('#timeslots');
  root.innerHTML = '';
  if (!date){
    root.textContent = 'Select a date to see available timeslots.';
    $('#availText').textContent = 'No date selected';
    return;
  }

  const svcId = $('#service').value;
  const svc = SERVICES.find(s=>s.id === svcId) || SERVICES[0];
  const dur = svc.durMins;
  const slots = generateSlots(dur, 60);
  const bookings = getBookings();

  let availableCount = 0;
  slots.forEach(ts => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'timeslot';
    btn.textContent = ts;
    btn.setAttribute('role','radio');
    btn.setAttribute('aria-checked','false');

    const conflict = bookings.some(b => overlap(date, ts, dur, b.date, b.time, b.durMins));
    if (conflict){
      btn.setAttribute('aria-disabled','true');
      btn.disabled = true;
      btn.title = 'Unavailable';
    } else {
      availableCount++;
      btn.tabIndex = 0;
    }

    btn.addEventListener('click', (e) => {
      if (btn.disabled) return;
      $$('.timeslot', root).forEach(n => { n.setAttribute('aria-checked','false'); n.classList.remove('selected'); });
      btn.setAttribute('aria-checked','true');
      btn.classList.add('selected');
      updateSummary();
      btn.focus();
    });

    btn.addEventListener('keydown', (e) => {
      if (['ArrowLeft','ArrowUp','ArrowRight','ArrowDown'].includes(e.key)){
        e.preventDefault();
        const all = $$('.timeslot', root);
        const idx = all.indexOf(btn);
        let nextIdx = idx;
        if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') nextIdx = Math.max(0, idx-1);
        if (e.key === 'ArrowRight' || e.key === 'ArrowDown') nextIdx = Math.min(all.length-1, idx+1);
        all[nextIdx].focus();
      } else if (e.key === 'Enter' || e.key === ' '){
        e.preventDefault();
        btn.click();
      }
    });

    root.appendChild(btn);
  });

  $('#availText').textContent = availableCount ? `${availableCount} slots available` : 'No available slots on selected date';
}
function getSelectedTimeslot(){
  const el = $('.timeslot[aria-checked="true"]');
  return el ? el.textContent.trim() : null;
}

/* ---------- Pricing & summary ---------- */
function calcPriceAndDuration(){
  const svc = SERVICES.find(s => s.id === $('#service').value) || SERVICES[0];
  let extrasChosen = $$('[data-extra]:checked').map(c => c.dataset.extra);
  let extrasSum = 0, extrasMins = 0, extrasList = [];
  extrasChosen.forEach(id => {
    const e = EXTRAS.find(x => x.id === id);
    if (e){ extrasSum += e.price; extrasMins += e.mins; extrasList.push(e.name); }
  });

  const beds = Number($('#bedrooms').value || 0);
  const baths = Number($('#bathrooms').value || 0);
  const roomsAdj = Math.max(0, beds - 1) * 150 + Math.max(0, baths - 1) * 80;

  const subtotal = svc.price + extrasSum + roomsAdj;
  const tax = Math.round(subtotal * 0.12);

  let promo = $('#promo').value.trim().toUpperCase();
  let promoVal = 0;
  if (promo && PROMOS[promo]){
    const p = PROMOS[promo];
    if (p.type === 'pct') promoVal = Math.round(subtotal * (p.value/100));
    else promoVal = p.value;
  } else promo = '';

  const total = Math.max(0, subtotal + tax - promoVal);

  return {
    base: svc.price,
    extrasSum, extrasMins, extrasList, roomsAdj,
    subtotal, tax, promo, promoVal, total,
    durationMins: svc.durMins + extrasMins,
    serviceName: svc.name
  };
}
function updateSummary(){
  const price = calcPriceAndDuration();
  $('#sumService').textContent = price.serviceName;
  $('#sumExtras').textContent = price.extrasList.length ? price.extrasList.join(', ') : 'None';
  const date = $('#date').value;
  const time = getSelectedTimeslot();
  $('#sumDate').textContent = (date && time) ? `${date} ${time}` : 'â€”';
  $('#sumDuration').textContent = price.durationMins ? `${Math.floor(price.durationMins/60)}h ${price.durationMins%60}m` : 'â€”';
  $('#sumAddress').textContent = $('#address').value || 'â€”';

  $('#priceService').textContent = `â‚±${price.base}`;
  $('#priceExtras').textContent = `â‚±${price.extrasSum}`;
  $('#priceRooms').textContent = `â‚±${price.roomsAdj}`;
  $('#priceTax').textContent = `â‚±${price.tax}`;
  $('#pricePromo').textContent = `-â‚±${price.promoVal}`;
  $('#priceTotal').textContent = `â‚±${price.total}`;

  const can = formValid(false);
  $('#confirmBooking').disabled = !can;
  $('#bookNow').disabled = !can;
}

/* ---------- Validation ---------- */
function formValid(showErrors = true){
  const errors = [];
  const service = $('#service').value;
  const date = $('#date').value;
  const time = getSelectedTimeslot();
  const address = $('#address').value.trim();
  const name = $('#name').value.trim();
  const phone = $('#phone').value.trim();
  const terms = $('#terms').checked;

  if (!service) errors.push('Please select a service.');
  if (!date) errors.push('Please pick a preferred date.');
  else {
    const d = new Date(date + 'T00:00:00');
    const today = new Date(todayISO() + 'T00:00:00');
    if (d < today) errors.push('Date cannot be in the past.');
  }
  if (!time) errors.push('Please select a time slot.');
  if (!address) errors.push('Please enter your address.');
  if (!name) errors.push('Please enter your full name.');
  if (!phone || !/^\+?\d[\d\s\-]{7,}$/.test(phone)) errors.push('Please enter a valid phone number (include country code).');
  if (!terms) errors.push('You must agree to terms and policies.');

  const errArea = $('#formErrors');
  if (showErrors){
    errArea.innerHTML = '';
    if (errors.length){
      const ul = document.createElement('ul');
      errors.forEach(msg => {
        const li = document.createElement('li'); li.textContent = msg;
        ul.appendChild(li);
      });
      errArea.appendChild(ul);
      const map = [
        { msg: 'Please select a service.', el: '#service' },
        { msg: 'Please pick a preferred date.', el: '#date' },
        { msg: 'Date cannot be in the past.', el: '#date' },
        { msg: 'Please select a time slot.', el: '#timeslots' },
        { msg: 'Please enter your address.', el: '#address' },
        { msg: 'Please enter your full name.', el: '#name' },
        { msg: 'Please enter a valid phone number (include country code).', el: '#phone' },
        { msg: 'You must agree to terms and policies.', el: '#terms' }
      ];
      const first = map.find(m => errors.includes(m.msg));
      if (first) $(first.el).focus();
    }
  }
  return errors.length === 0;
}

/* ---------- Booking creation & persistence ---------- */
function createBookingObject(){
  const price = calcPriceAndDuration();
  const booking = {
    id: generateBookingId(),
    serviceId: $('#service').value,
    serviceName: price.serviceName,
    date: $('#date').value,
    time: getSelectedTimeslot(),
    durMins: price.durationMins,
    extras: $$('[data-extra]:checked').map(c => c.dataset.extra),
    bedrooms: $('#bedrooms').value,
    bathrooms: $('#bathrooms').value,
    name: $('#name').value.trim(),
    phone: $('#phone').value.trim(),
    email: $('#email').value.trim(),
    address: $('#address').value.trim(),
    notes: $('#notes').value.trim(),
    promo: price.promo || null,
    price: price.total,
    created: new Date().toISOString(),
    status: 'pending'
  };
  return booking;
}
function generateBookingId(){
  return 'BK-' + Math.floor(Math.random()*900000 + 100000);
}
function slotConflictExists(booking){
  const bookings = getBookings();
  return bookings.some(b => overlap(booking.date, booking.time, booking.durMins, b.date, b.time, b.durMins));
}

/* ---------- Submit & confirmation ---------- */
function submitBooking(e){
  e.preventDefault();
  $('#formErrors').textContent = '';
  if (!formValid(true)) return;

  const booking = createBookingObject();

  if (slotConflictExists(booking)){
    $('#formErrors').textContent = 'Selected timeslot is no longer available. Please choose another slot.';
    renderTimeslots();
    return;
  }

  const bookings = getBookings();
  bookings.push(booking);
  saveBookings(bookings);

  openConfirmationModal(booking);
  updateSummary();
}

/* ---------- Confirmation modal & .ics ---------- */
function openConfirmationModal(b){
  $('#confirmId').textContent = b.id;
  $('#confirmMsg').textContent = `Thank you â€” your booking ${b.id} was saved to your browser.`;
  $('#confirmSummary').innerHTML = `
    <div><strong>${b.serviceName}</strong></div>
    <div>${b.date} ${b.time} â€¢ ${Math.floor(b.durMins/60)}h ${b.durMins%60}m</div>
    <div>${b.name} â€¢ ${b.phone}</div>
    <div>${b.address}</div>
    <div style="margin-top:8px;"><strong>Total:</strong> â‚±${b.price}</div>
  `;
  const modal = $('#confirmModal');
  modal.hidden = false;
  document.body.style.overflow = 'hidden';
  $('#closeConfirm').focus();
  installFocusTrap(modal);

  $('#downloadIcs').onclick = () => downloadIcs(b);
  $('#printConfirm').onclick = () => window.print();
}
function closeConfirmationModal(){
  const modal = $('#confirmModal');
  modal.hidden = true;
  document.body.style.overflow = '';
  releaseFocusTrap(modal);
}
function downloadIcs(b){
  const start = new Date(b.date + 'T' + b.time + ':00');
  const endMinutes = hhmmToMins(b.time) + b.durMins;
  const endH = String(Math.floor(endMinutes/60)).padStart(2,'0'), endM = String(endMinutes%60).padStart(2,'0');
  const end = new Date(`${b.date}T${endH}:${endM}:00`);

  function formatIcsDate(d){
    const pad = n => String(n).padStart(2,'0');
    return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}T${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
  }

  const icsParts = [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//QuickClean Demo//EN',
    'BEGIN:VEVENT',
    `UID:${b.id}@quickclean.demo`,
    `DTSTAMP:${formatIcsDate(new Date())}`,
    `DTSTART:${formatIcsDate(start)}`,
    `DTEND:${formatIcsDate(end)}`,
    `SUMMARY:QuickClean â€” ${b.serviceName}`,
    `DESCRIPTION:Booking ${b.id} â€” ${b.name} â€” ${b.phone}`,
    `LOCATION:${b.address}`,
    'END:VEVENT',
    'END:VCALENDAR'
  ].join('\r\n');

  const blob = new Blob([icsParts], { type: 'text/calendar;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${b.id}.ics`;
  a.click();
  URL.revokeObjectURL(url);
}

/* ---------- Focus trap for modal ---------- */
function installFocusTrap(modalEl){
  releaseFocusTrap(modalEl);
  const focusable = $$('a[href], button:not([disabled]), textarea, input, select', modalEl).filter(n => n.offsetParent !== null);
  if (!focusable.length) return;
  const first = focusable[0], last = focusable[focusable.length - 1];
  const handler = (e) => {
    if (e.key !== 'Tab') return;
    if (e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
    else if (!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
  };
  modalEl._trapHandler = handler;
  document.addEventListener('keydown', handler);
}
function releaseFocusTrap(modalEl){
  if (modalEl && modalEl._trapHandler){ document.removeEventListener('keydown', modalEl._trapHandler); modalEl._trapHandler = null; }
}

/* ---------- Promo & reset ---------- */
function applyPromo(){
  const code = $('#promo').value.trim().toUpperCase();
  if (!code){ $('#promoMsg').textContent = 'Enter a promo code.'; updateSummary(); return; }
  if (!PROMOS[code]){ $('#promoMsg').textContent = 'Invalid promo code.'; updateSummary(); return; }
  $('#promoMsg').textContent = `Promo ${code} applied.`;
  updateSummary();
}
function resetDemo(){
  localStorage.removeItem(LS_BOOKINGS);
  localStorage.removeItem(LS_SEEDED);
  seedDemoBookings();
  renderTimeslots();
  updateSummary();
  $('#promoMsg').textContent = '';
  $('#formErrors').textContent = '';
  alert('Demo data reset.');
}

/* ---------- Event wiring & initialization ---------- */
document.addEventListener('DOMContentLoaded', () => {
  seedDemoBookings();
  populateServices();
  populateExtras();

  $('#date').value = todayISO();
  renderTimeslots();
  updateSummary();

  $('#service').addEventListener('change', () => { $('#serviceDesc').textContent = SERVICES.find(s=> s.id === $('#service').value).name; renderTimeslots(); updateSummary(); });
  $('#date').addEventListener('change', () => { renderTimeslots(); updateSummary(); });
  $('#bedrooms').addEventListener('change', updateSummary);
  $('#bathrooms').addEventListener('change', updateSummary);
  $('#extrasList').addEventListener('change', updateSummary);
  $('#applyPromo').addEventListener('click', applyPromo);

  $('#startBooking').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('booking').scrollIntoView({behavior:'smooth'}); $('#service').focus(); });

  $('#bookingForm').addEventListener('submit', submitBooking);
  $('#bookNow').addEventListener('click', () => $('#confirmBooking').click());
  $('#resetDemo').addEventListener('click', resetDemo);

  $('#closeConfirm').addEventListener('click', closeConfirmationModal);
  $('#closeConfirm2').addEventListener('click', closeConfirmationModal);
  $('#confirmBackdrop').addEventListener('click', (e) => { if (e.target === $('#confirmBackdrop')) closeConfirmationModal(); });
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { if (!$('#confirmModal').hidden) closeConfirmationModal(); } });

  ['service','date','bedrooms','bathrooms','address','name','phone','notes','promo'].forEach(id => {
    const el = $('#' + id); if (!el) return;
    el.addEventListener('input', debounce(() => updateSummary(), 160));
    el.addEventListener('change', () => updateSummary());
  });

  // NEW: Smooth scroll behavior when nav Services is clicked -> focus service select.
  document.getElementById('navServices').addEventListener('click', function(evt){
    evt.preventDefault();
    // scroll to the service label/select area; prefer focusing the select
    const target = document.getElementById('service');
    if (target){
      target.scrollIntoView({ behavior: 'smooth', block: 'center' });
      // small timeout to ensure scroll finished before focus for some browsers
      setTimeout(()=> {
        target.focus({ preventScroll:true });
      }, 300);
    }
    // optionally set URL fragment for deep-linking
    history.replaceState(null, '', '#services');
  });

  // Also: clicking the "Services" anchor via keyboard (Enter) will work since above is a click handler.

  // Live re-render timeslots on storage events (if another window changed bookings)
  window.addEventListener('storage', () => { renderTimeslots(); updateSummary(); });

  renderTimeslots();
});

/* ---------- small debounce helper ---------- */
function debounce(fn, ms=180){
  let t;
  return (...args) => { clearTimeout(t); t = setTimeout(()=> fn(...args), ms); };
}
</script>
</body>
</html>