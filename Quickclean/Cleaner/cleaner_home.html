<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QuickClean — Cleaner Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;800&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root{
  --brand-blue: #66B7F0;
  --nav-yellow: #FFDB58;
  --cta-yellow: #FFD54A;
  --text-blue: #2E89F0;
  --muted-bg: #f6f7f8;
  --accent:#1b4d7a;
  --max-w:1200px;
  --gap:16px;
}

/* Reset & base */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  background:#ffffff;
  color:#0f2a3a;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  line-height:1.4;
}

/* Header */
.site-header{
  background:var(--brand-blue);
  height:88px;
  display:flex;
  align-items:center;
  width:100%;
  box-shadow: 0 1px 0 rgba(0,0,0,0.04);
}
.header-inner{
  width:100%;
  max-width:var(--max-w);
  margin:0 auto;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 20px;
}
.logo{ height:56px; width:auto; }
.header-center{ flex:1; display:flex; justify-content:center; align-items:center; }
.tagline{ font-family:"Baloo 2", "Poppins", sans-serif; color:#fff; font-weight:700; font-size:18px; }

/* Nav band (centered links but minimal since this page is for employees) */
.nav-bar{ background:var(--nav-yellow); padding:8px 0; box-shadow:0 1px 0 rgba(0,0,0,0.06); }
.nav-list{ max-width:var(--max-w); margin:0 auto; padding:0 20px; display:flex; gap:26px; justify-content:center; list-style:none; align-items:center; flex-wrap:wrap; }
.nav-list a{ color:#0b3b66; font-weight:600; text-decoration:none; }

/* Page layout */
.app{
  max-width:var(--max-w);
  margin:22px auto;
  padding:0 20px 80px;
}

/* Top controls */
.top-controls{
  display:flex;
  gap:16px;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
  margin-bottom:18px;
}
.left-controls{
  display:flex;
  gap:12px;
  align-items:center;
}
select, input[type="search"]{
  padding:10px 12px;
  border-radius:8px;
  border:1px solid rgba(0,0,0,0.08);
  font-size:14px;
}
.status-filters{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.filter-btn{
  background:transparent;
  border:1px solid rgba(0,0,0,0.08);
  padding:8px 10px;
  border-radius:8px;
  cursor:pointer;
}
.filter-btn.active{ background:var(--text-blue); color:#fff; border-color:var(--text-blue); }

/* Main grid: bookings list + side panel */
.main-grid{
  display:grid;
  grid-template-columns: 1fr 320px;
  gap:20px;
}

/* Bookings list */
.bookings-panel{
  background:#fff;
  border-radius:10px;
  padding:14px;
  box-shadow: 0 8px 20px rgba(16,41,71,0.06);
}
.bookings-header{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:10px; }
.bookings-list{ display:flex; flex-direction:column; gap:10px; max-height:66vh; overflow:auto; padding-right:6px; }

/* Booking item */
.booking-item{
  border-radius:8px;
  padding:12px;
  background: linear-gradient(180deg, #fff, #fbfdff);
  display:flex;
  gap:12px;
  align-items:flex-start;
  border:1px solid rgba(0,0,0,0.04);
}
.booking-meta{ flex:1; display:flex; flex-direction:column; gap:6px; }
.booking-top{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
.customer-name{ font-weight:700; color:var(--accent); }
.booking-sub{ color:#456c82; font-size:13px; }
.badge{ padding:6px 10px; border-radius:999px; font-weight:700; font-size:13px; background:#eef6ff; color:var(--accent); border:1px solid rgba(46,137,240,0.06); }

/* action buttons */
.booking-actions{ display:flex; gap:8px; margin-top:8px; }
.btn-accept{ background:#2ea44f; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
.btn-decline{ background:#f06666; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
.btn-small{ background:transparent; border:1px solid rgba(0,0,0,0.08); padding:8px 10px; border-radius:8px; cursor:pointer; }

/* side panel */
.side-panel{
  display:flex;
  flex-direction:column;
  gap:12px;
}
.card{ background:#fff; border-radius:10px; padding:12px; box-shadow:0 8px 20px rgba(16,41,71,0.06); }

/* availability */
.avail-toggle{ display:flex; align-items:center; gap:8px; justify-content:space-between; }
.toggle-btn{ padding:10px 12px; border-radius:8px; cursor:pointer; background:transparent; border:1px solid rgba(0,0,0,0.08); }

/* activity log */
.activity-list{ max-height:36vh; overflow:auto; display:flex; flex-direction:column; gap:8px; }

/* modal */
.modal[hidden]{ display:none; }
.modal{
  position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:1400;
}
.modal-backdrop{ position:absolute; inset:0; background:rgba(2,6,23,0.55); }
.modal-panel{
  position:relative; width:min(920px,96%); max-height:88vh; overflow:auto; background:#fff; border-radius:12px; padding:18px; z-index:2;
  box-shadow:0 24px 48px rgba(8,18,30,0.3);
}
.modal-close{ position:absolute; right:12px; top:10px; background:transparent; border:none; font-size:22px; cursor:pointer; }
.modal-grid{ display:grid; grid-template-columns: 300px 1fr; gap:14px; align-items:start; }
.modal-photo{ width:100%; height:220px; object-fit:cover; border-radius:8px; }

/* details */
.detail-row{ margin-top:6px; display:flex; gap:10px; flex-wrap:wrap; }
.notes{ margin-top:12px; border-top:1px dashed rgba(0,0,0,0.06); padding-top:10px; }

/* toast */
.toast{ position:fixed; right:18px; bottom:18px; background:#0b4b78; color:#fff; padding:12px 16px; border-radius:8px; box-shadow:0 12px 24px rgba(0,0,0,0.18); z-index:1600; }

/* small screens */
@media (max-width: 900px){
  .main-grid{ grid-template-columns: 1fr; }
  .header-inner{ padding:12px; }
  .site-header{ height:86px }
}

/* focus visible */
:focus{ outline:3px solid rgba(46,137,240,0.18); outline-offset:3px; }
</style>
</head>
<body>

<!-- Header -->
<header class="site-header" role="banner">
  <div class="header-inner">
    <div class="header-left"><img class="logo" src="assets/logo.png" alt="QuickClean logo"></div>
    <div class="header-center"><div class="tagline">QuickClean: Clean Spaces, Happy Faces.</div></div>
    <div class="header-right" aria-hidden="false"><img class="logo" src="assets/profile.png" alt="profile" style="width:48px;height:48px;border-radius:50%"></div>
  </div>
</header>

<!-- nav band -->
<nav class="nav-bar" role="navigation" aria-label="Main navigation">
  <ul class="nav-list">
    <li><a href="#" class="">Dashboard</a></li>
    <li><a href="#" class="">Schedule</a></li>
    <li><a href="#" class="">Messages</a></li>
  </ul>
</nav>

<main class="app" id="app" role="main">
  <div class="top-controls">
    <div class="left-controls">
      <label for="userSelect" class="sr-only">Signed in as</label>
      <select id="userSelect" aria-label="Signed in as">
        <!-- options populated by JS -->
      </select>

      <label for="statusFilter" class="sr-only">Status filter</label>
      <select id="statusFilter" aria-label="Status">
        <option value="">All statuses</option>
        <option value="pending">Pending</option>
        <option value="assigned">Assigned</option>
        <option value="in-progress">In-Progress</option>
        <option value="completed">Completed</option>
        <option value="rejected">Rejected</option>
      </select>

      <input id="search" type="search" placeholder="Search customer or address" aria-label="Search bookings">
      <button class="filter-btn" id="refreshBtn">Refresh</button>
    </div>

    <div style="display:flex;gap:10px;align-items:center;">
      <div class="status-filters" role="tablist" aria-label="Quick filters">
        <button class="filter-btn quick" data-status="">All</button>
        <button class="filter-btn quick" data-status="pending">Pending</button>
        <button class="filter-btn quick" data-status="assigned">Assigned</button>
        <button class="filter-btn quick" data-status="in-progress">In-Progress</button>
        <button class="filter-btn quick" data-status="completed">Completed</button>
      </div>
      <button id="resetDemo" class="filter-btn" title="Reset demo data">Reset demo data</button>
    </div>
  </div>

  <div class="main-grid">
    <!-- bookings list -->
    <section class="bookings-panel" aria-labelledby="bookingsHeading">
      <div class="bookings-header">
        <h2 id="bookingsHeading">Bookings</h2>
        <div id="counts" style="color:#234e6f;font-weight:700">Loading…</div>
      </div>

      <div class="bookings-list" id="bookingsList" tabindex="0" aria-live="polite">
        <!-- booking items inserted by JS -->
      </div>
    </section>

    <!-- side panel -->
    <aside class="side-panel">
      <div class="card">
        <h3>Profile & Availability</h3>
        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div>
            <div id="signedName" style="font-weight:700;color:var(--accent)"></div>
            <div id="signedRole" style="font-size:13px;color:#456c82"></div>
          </div>
          <div>
            <button id="toggleOnline" class="toggle-btn">Toggle Online</button>
          </div>
        </div>
        <div style="margin-top:10px">
          <label class="sr-only" for="hours">Hours</label>
          <input id="hours" placeholder="e.g., Weekdays 8am–5pm" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08)">
        </div>
        <div style="margin-top:10px;font-size:13px;color:#2a546d">
          <strong>Status:</strong> <span id="onlineStatus">—</span>
        </div>
      </div>

      <div class="card">
        <h3>Activity</h3>
        <div class="activity-list" id="activityList" aria-live="polite">
          <!-- activity entries -->
        </div>
      </div>

      <div class="card">
        <h3>Quick Actions</h3>
        <button id="viewMyAssigned" class="filter-btn" style="width:100%;">View My Assigned</button>
        <button id="viewPending" class="filter-btn" style="width:100%;">View Pending</button>
      </div>
    </aside>
  </div>

  <!-- Toast area -->
  <div id="toastArea" aria-live="polite" style="position:fixed;right:18px;bottom:18px;z-index:1600"></div>
</main>

<!-- Booking detail modal -->
<div id="detailModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" hidden>
  <div class="modal-backdrop" data-dismiss="true"></div>
  <div class="modal-panel" role="document">
    <button class="modal-close" id="detailClose" aria-label="Close">&times;</button>
    <div class="modal-grid">
      <div>
        <img id="detailPhoto" class="modal-photo" src="" alt="">
      </div>
      <div>
        <h3 id="modalTitle">Booking</h3>
        <div class="detail-row"><strong>Customer:</strong> <span id="detailCustomer"></span></div>
        <div class="detail-row"><strong>Phone:</strong> <span id="detailPhone"></span></div>
        <div class="detail-row"><strong>Address:</strong> <span id="detailAddress"></span></div>
        <div class="detail-row"><strong>Service:</strong> <span id="detailService"></span></div>
        <div class="detail-row"><strong>Date/Time:</strong> <span id="detailDate"></span></div>
        <div class="detail-row"><strong>Status:</strong> <span id="detailStatus" class="badge"></span></div>

        <div class="notes">
          <h4>Internal notes</h4>
          <div id="detailNotes"></div>
          <textarea id="noteInput" placeholder="Add a note (visible to cleaners)" rows="3" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);margin-top:8px"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="addNoteBtn" class="filter-btn">Add Note</button>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <!-- action buttons inserted dynamically -->
          <div id="actionButtons"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* Employee dashboard JS (single-file) */

/* SAMPLE DATA (used to initialize localStorage if not present) */
const SAMPLE_CLEANERS = [
  { id: 'c-jane', name: 'Jane Doe', role: 'Senior Cleaner', photo: 'assets/cleaners/jane-doe.jpg', online: true, hours: 'Weekdays 8am–4pm' },
  { id: 'c-maria', name: 'Maria Rios', role: 'Home Cleaning Specialist', photo: 'assets/cleaners/maria-rios.jpg', online: true, hours: 'Weekends & mornings' },
  { id: 'c-angelo', name: 'Angelo Luna', role: 'Post-Construction Expert', photo: 'assets/cleaners/angelo-luna.jpg', online: false, hours: 'Flexible' }
];

const SAMPLE_BOOKINGS = [
  { id: 'b-001', customer: 'Anna Santos', phone: '+63 912 345 6789', address:'Unit 12, Dream Tower, QC', service:'Deep Cleaning', datetime:'2025-09-20T09:00', status:'pending', assignedTo:null, notes:[] , photo:'assets/cleaners/jane-doe.jpg'},
  { id: 'b-002', customer: 'Peter Lim', phone: '+63 917 222 3333', address:'House 5, Green St., Manila', service:'Regular Cleaning', datetime:'2025-09-19T14:00', status:'assigned', assignedTo:'c-maria', notes:[{by:'system',text:'Client requests green-friendly products.'}] , photo:'assets/cleaners/maria-rios.jpg'},
  { id: 'b-003', customer: 'Liza Cruz', phone: '+63 921 111 2222', address:'Apt 8B, Oceanview', service:'Move-in/Move-out Cleaning', datetime:'2025-09-22T10:00', status:'pending', assignedTo:null, notes:[], photo:'assets/cleaners/angelo-luna.jpg'},
  { id: 'b-004', customer: 'Mark Reyes', phone: '+63 918 444 5555', address:'Lot 34, Pine Village', service:'Upholstery Cleaning', datetime:'2025-09-18T08:30', status:'in-progress', assignedTo:'c-jane', notes:[{by:'c-jane',text:'On site, starting now.'}], photo:'assets/cleaners/jane-doe.jpg'}
];

/* Storage keys */
const KEY_BOOKINGS = 'qc_demo_bookings';
const KEY_CLEANERS = 'qc_demo_cleaners';

/* DOM refs */
const userSelect = document.getElementById('userSelect');
const bookingsList = document.getElementById('bookingsList');
const statusFilter = document.getElementById('statusFilter');
const search = document.getElementById('search');
const counts = document.getElementById('counts');
const quickBtns = document.querySelectorAll('.quick');
const refreshBtn = document.getElementById('refreshBtn');
const resetDemoBtn = document.getElementById('resetDemo');
const signedNameEl = document.getElementById('signedName');
const signedRoleEl = document.getElementById('signedRole');
const toggleOnlineBtn = document.getElementById('toggleOnline');
const onlineStatusEl = document.getElementById('onlineStatus');
const hoursInput = document.getElementById('hours');
const activityList = document.getElementById('activityList');
const viewMyAssigned = document.getElementById('viewMyAssigned');
const viewPending = document.getElementById('viewPending');

const detailModal = document.getElementById('detailModal');
const detailClose = document.getElementById('detailClose');
const detailPhoto = document.getElementById('detailPhoto');
const detailCustomer = document.getElementById('detailCustomer');
const detailPhone = document.getElementById('detailPhone');
const detailAddress = document.getElementById('detailAddress');
const detailService = document.getElementById('detailService');
const detailDate = document.getElementById('detailDate');
const detailStatus = document.getElementById('detailStatus');
const detailNotes = document.getElementById('detailNotes');
const noteInput = document.getElementById('noteInput');
const addNoteBtn = document.getElementById('addNoteBtn');
const actionButtons = document.getElementById('actionButtons');
const bookingForm = document.getElementById('bookingForm');

const toastArea = document.getElementById('toastArea');

/* State */
let cleaners = [];
let bookings = [];
let currentCleanerId = null;
let filteredBookings = [];

/* Utils */
function loadData(){
  const b = localStorage.getItem(KEY_BOOKINGS);
  const c = localStorage.getItem(KEY_CLEANERS);
  if (!c || !b){
    // initialize
    localStorage.setItem(KEY_CLEANERS, JSON.stringify(SAMPLE_CLEANERS));
    localStorage.setItem(KEY_BOOKINGS, JSON.stringify(SAMPLE_BOOKINGS));
  }
  cleaners = JSON.parse(localStorage.getItem(KEY_CLEANERS) || '[]');
  bookings = JSON.parse(localStorage.getItem(KEY_BOOKINGS) || '[]');
}

function saveBookings(){
  localStorage.setItem(KEY_BOOKINGS, JSON.stringify(bookings));
}

function saveCleaners(){
  localStorage.setItem(KEY_CLEANERS, JSON.stringify(cleaners));
}

function toast(msg, timeout=2800){
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = msg;
  toastArea.appendChild(el);
  setTimeout(()=> { el.style.opacity = '0'; setTimeout(()=> el.remove(),400); }, timeout);
}

/* Render cleanres select */
function renderUserSelect(){
  userSelect.innerHTML = '';
  cleaners.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.name + ' — ' + c.role;
    userSelect.appendChild(opt);
  });
  // default to first if none selected
  if (!currentCleanerId){
    currentCleanerId = cleaners[0]?.id;
  }
  userSelect.value = currentCleanerId;
  updateSignedIn();
}

/* update signed in panel */
function updateSignedIn(){
  const c = cleaners.find(x => x.id === userSelect.value) || cleaners[0];
  if (!c) return;
  currentCleanerId = c.id;
  signedNameEl.textContent = c.name;
  signedRoleEl.textContent = c.role;
  onlineStatusEl.textContent = c.online ? 'Online' : 'Offline';
  toggleOnlineBtn.textContent = c.online ? 'Go Offline' : 'Go Online';
  hoursInput.value = c.hours || '';
}

/* Render bookings list */
function renderBookings(list){
  bookingsList.innerHTML = '';
  if (!list.length){
    bookingsList.innerHTML = '<div style="color:#456c82;padding:12px">No bookings found.</div>';
    counts.textContent = '0';
    return;
  }
  counts.textContent = list.length;
  list.forEach(b => {
    const el = document.createElement('div');
    el.className = 'booking-item';
    el.innerHTML = `
      <div style="width:76px;">
        <img src="${b.photo||'assets/cleaners/jane-doe.jpg'}" alt="${b.customer}" style="width:72px;height:72px;object-fit:cover;border-radius:8px">
      </div>
      <div class="booking-meta">
        <div class="booking-top">
          <div>
            <div class="customer-name">${b.customer}</div>
            <div class="booking-sub">${b.service} • ${new Date(b.datetime).toLocaleString()}</div>
            <div class="booking-sub" style="font-size:13px">${b.address}</div>
          </div>
          <div>
            <div class="badge">${b.status.toUpperCase()}</div>
            <div style="margin-top:8px;font-size:12px;color:#5a7a8f">${b.assignedTo ? getCleanerName(b.assignedTo) : 'Unassigned'}</div>
          </div>
        </div>
        <div class="booking-actions">
          <button class="btn-small view-detail" data-id="${b.id}">View</button>
          ${b.status === 'pending' ? `<button class="btn-accept accept" data-id="${b.id}">Accept</button><button class="btn-decline decline" data-id="${b.id}">Decline</button>` : ''}
          ${b.status === 'assigned' && b.assignedTo === currentCleanerId ? `<button class="btn-small start" data-id="${b.id}">Start</button>` : ''}
          ${b.status === 'in-progress' && b.assignedTo === currentCleanerId ? `<button class="btn-small complete" data-id="${b.id}">Complete</button>` : ''}
        </div>
      </div>
    `;
    bookingsList.appendChild(el);
  });

  // attach listeners
  bookingsList.querySelectorAll('.view-detail').forEach(btn=>btn.addEventListener('click', e=>openDetail(e.target.dataset.id)));
  bookingsList.querySelectorAll('.accept').forEach(btn=>btn.addEventListener('click', e=>acceptBooking(e.target.dataset.id)));
  bookingsList.querySelectorAll('.decline').forEach(btn=>btn.addEventListener('click', e=>declineBooking(e.target.dataset.id)));
  bookingsList.querySelectorAll('.start').forEach(btn=>btn.addEventListener('click', e=>startBooking(e.target.dataset.id)));
  bookingsList.querySelectorAll('.complete').forEach(btn=>btn.addEventListener('click', e=>completeBooking(e.target.dataset.id)));
}

/* Helpers */
function getCleanerName(id){
  return cleaners.find(c=>c.id===id)?.name || '—';
}

/* Filtering & searching */
function applyFilters(){
  const status = statusFilter.value;
  const q = (search.value||'').toLowerCase().trim();
  filteredBookings = bookings.filter(b=>{
    if (status && b.status !== status) return false;
    if (q){
      const hay = (b.customer + ' ' + b.address + ' ' + b.service).toLowerCase();
      if (!hay.includes(q)) return false;
    }
    return true;
  });
  renderBookings(filteredBookings);
}

/* Actions */
function acceptBooking(id){
  const b = bookings.find(x=>x.id===id);
  if (!b) return;
  if (b.status !== 'pending') { toast('Booking no longer pending'); return; }
  b.status = 'assigned';
  b.assignedTo = currentCleanerId;
  b.notes = b.notes || [];
  b.notes.push({by: getCleanerName(currentCleanerId), text:'Accepted by ' + getCleanerName(currentCleanerId), ts: new Date().toISOString()});
  saveBookings();
  logActivity(`Accepted booking ${b.id} for ${b.customer}`);
  toast('Booking accepted');
  applyFilters();
}

function declineBooking(id){
  const b = bookings.find(x=>x.id===id);
  if (!b) return;
  if (b.status !== 'pending') { toast('Booking no longer pending'); return; }
  b.status = 'rejected';
  b.notes = b.notes || [];
  b.notes.push({by: getCleanerName(currentCleanerId), text:'Declined by ' + getCleanerName(currentCleanerId), ts: new Date().toISOString()});
  saveBookings();
  logActivity(`Declined booking ${b.id}`);
  toast('Booking declined');
  applyFilters();
}

function startBooking(id){
  const b = bookings.find(x=>x.id===id);
  if (!b) return;
  if (b.assignedTo !== currentCleanerId) { toast('Not assigned to you'); return; }
  b.status = 'in-progress';
  b.notes = b.notes || [];
  b.notes.push({by: getCleanerName(currentCleanerId), text:'Started job', ts: new Date().toISOString()});
  saveBookings();
  logActivity(`Started booking ${b.id}`);
  toast('Marked in-progress');
  applyFilters();
}

function completeBooking(id){
  const b = bookings.find(x=>x.id===id);
  if (!b) return;
  if (b.assignedTo !== currentCleanerId) { toast('Not assigned to you'); return; }
  b.status = 'completed';
  b.notes = b.notes || [];
  b.notes.push({by: getCleanerName(currentCleanerId), text:'Completed job', ts: new Date().toISOString()});
  saveBookings();
  logActivity(`Completed booking ${b.id}`);
  toast('Marked completed');
  applyFilters();
}

/* Open detail modal & populate */
let currentDetailId = null;
function openDetail(id){
  const b = bookings.find(x=>x.id===id);
  if (!b) return;
  currentDetailId = id;
  detailPhoto.src = b.photo || 'assets/cleaners/jane-doe.jpg';
  detailPhoto.alt = b.customer;
  detailCustomer.textContent = b.customer;
  detailPhone.textContent = b.phone;
  detailAddress.textContent = b.address;
  detailService.textContent = b.service;
  detailDate.textContent = new Date(b.datetime).toLocaleString();
  detailStatus.textContent = b.status.toUpperCase();
  detailStatus.className = 'badge';
  // notes
  detailNotes.innerHTML = '';
  (b.notes || []).forEach(n=>{
    const p = document.createElement('div');
    p.innerHTML = `<strong style="color:#0b4b78">${n.by}</strong> <span style="color:#456c82">• ${new Date(n.ts||Date.now()).toLocaleString()}</span><div style="margin-top:6px">${n.text}</div><hr style="border:none;border-top:1px dashed #eee;margin:8px 0">`;
    detailNotes.appendChild(p);
  });
  // actions
  renderDetailActions(b);
  // show modal
  openModal();
}

function renderDetailActions(b){
  actionButtons.innerHTML = '';
  const assignedToMe = b.assignedTo === currentCleanerId;
  // if pending -> accept/decline
  if (b.status === 'pending'){
    const accept = createEl('button','btn-accept','Accept');
    accept.addEventListener('click', ()=>{ acceptBooking(b.id); closeModal(); });
    const decline = createEl('button','btn-decline','Decline');
    decline.addEventListener('click', ()=>{ declineBooking(b.id); closeModal(); });
    actionButtons.appendChild(accept);
    actionButtons.appendChild(decline);
  }
  if (b.status === 'assigned' && assignedToMe){
    const start = createEl('button','btn-small','Start');
    start.addEventListener('click', ()=>{ startBooking(b.id); closeModal(); });
    actionButtons.appendChild(start);
  }
  if (b.status === 'in-progress' && assignedToMe){
    const complete = createEl('button','btn-small','Complete');
    complete.addEventListener('click', ()=>{ completeBooking(b.id); closeModal(); });
    actionButtons.appendChild(complete);
  }
  // always allow adding internal note
  const notebtn = createEl('button','btn-small','Add note (enter)');
  notebtn.addEventListener('click', ()=>{ addNote(); });
  actionButtons.appendChild(notebtn);
}

/* notes */
function addNote(){
  const text = noteInput.value.trim();
  if (!text) { toast('Note empty'); return; }
  const b = bookings.find(x=>x.id===currentDetailId);
  if (!b) return;
  b.notes = b.notes || [];
  b.notes.push({by: getCleanerName(currentCleanerId), text, ts: new Date().toISOString()});
  saveBookings();
  detailNotes.insertAdjacentHTML('afterbegin', `<div><strong style="color:#0b4b78">${getCleanerName(currentCleanerId)}</strong> <span style="color:#456c82">• ${new Date().toLocaleString()}</span><div style="margin-top:6px">${escapeHtml(text)}</div><hr style="border:none;border-top:1px dashed #eee;margin:8px 0"></div>`);
  noteInput.value = '';
  logActivity(`Added note to ${b.id}`);
  toast('Note added');
}

/* Modal helpers */
function openModal(){
  detailModal.hidden = false;
  document.body.style.overflow = 'hidden';
  detailClose.focus();
  trapFocus(detailModal);
}
function closeModal(){
  detailModal.hidden = true;
  document.body.style.overflow = '';
  releaseFocus(detailModal);
}

/* Focus trap for modal */
function trapFocus(modalEl){
  const focusable = modalEl.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])');
  if (!focusable.length) return;
  const first = focusable[0], last = focusable[focusable.length-1];
  function handler(e){
    if (e.key !== 'Tab') return;
    if (e.shiftKey){
      if (document.activeElement === first){ e.preventDefault(); last.focus(); }
    } else {
      if (document.activeElement === last){ e.preventDefault(); first.focus(); }
    }
  }
  modalEl._handler = handler;
  document.addEventListener('keydown', handler);
}
function releaseFocus(modalEl){
  if (modalEl._handler){ document.removeEventListener('keydown', modalEl._handler); modalEl._handler = null; }
}

/* activity log */
function logActivity(text){
  const el = document.createElement('div');
  el.innerHTML = `<div style="font-size:13px;color:#385b6a"><strong>${new Date().toLocaleString()}</strong> — ${escapeHtml(text)}</div>`;
  activityList.prepend(el);
}

/* util createEl */
function createEl(tag, cls='', text=''){
  const el = document.createElement(tag);
  if (cls) el.className = cls;
  el.textContent = text;
  return el;
}

/* escape */
function escapeHtml(s){ return s.replace?.(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') || s; }

/* toggle online */
function toggleOnline(){
  const c = cleaners.find(x=>x.id===currentCleanerId);
  if (!c) return;
  c.online = !c.online;
  saveCleaners();
  updateSignedInDisplay();
  toast(c.online ? 'You are online' : 'You are offline');
  logActivity(`${c.name} set ${c.online ? 'online' : 'offline'}`);
}

/* save hours */
function saveHours(){
  const c = cleaners.find(x=>x.id===currentCleanerId);
  if (!c) return;
  c.hours = hoursInput.value;
  saveCleaners();
  toast('Hours saved');
}

/* quick filter handlers */
function quickFilter(status){
  statusFilter.value = status;
  applyFilters();
  // set active on quick buttons
  quickBtns.forEach(b => b.classList.toggle('active', b.dataset.status === status));
}

/* reset demo (restore sample) */
function resetDemo(){
  localStorage.removeItem(KEY_BOOKINGS);
  localStorage.removeItem(KEY_CLEANERS);
  loadData();
  init(); // re-init rendering
  toast('Demo data reset');
}

/* helpers to load/refresh */
function refresh(){
  loadData();
  renderUserSelect();
  applyFilters();
  renderActivityFromBookings();
}

/* render activity from bookings initial */
function renderActivityFromBookings(){
  activityList.innerHTML = '';
  // show last few notes as activity
  const allNotes = bookings.flatMap(b => (b.notes || []).map(n=>({ts:n.ts||new Date().toISOString(),text:`[${b.id}] ${n.by}: ${n.text}`})));
  allNotes.sort((a,b)=> new Date(b.ts) - new Date(a.ts));
  allNotes.slice(0,10).forEach(n => {
    const el = document.createElement('div');
    el.innerHTML = `<div style="font-size:13px;color:#385b6a"><strong>${new Date(n.ts).toLocaleString()}</strong> — ${escapeHtml(n.text)}</div>`;
    activityList.appendChild(el);
  });
}

/* initialization */
function init(){
  loadData();
  renderUserSelect();
  renderActivityFromBookings();

  // list bookings initially
  applyFilters();

  // event listeners
  userSelect.addEventListener('change', ()=>{ updateSignedIn(); applyFilters(); });
  statusFilter.addEventListener('change', applyFilters);
  search.addEventListener('input', ()=>{ applyFilters(); });
  refreshBtn.addEventListener('click', ()=>{ refresh(); toast('Refreshed'); });
  resetDemoBtn.addEventListener('click', resetDemo);
  toggleOnlineBtn.addEventListener('click', ()=>{ toggleOnline(); saveCleaners(); updateSignedIn(); });
  hoursInput.addEventListener('change', saveHours);
  detailClose.addEventListener('click', closeModal);
  detailModal.querySelector('.modal-backdrop').addEventListener('click', closeModal);
  document.addEventListener('keydown', (e)=>{ if (e.key==='Escape') closeModal(); });

  quickBtns.forEach(b => b.addEventListener('click', ()=> quickFilter(b.dataset.status)));

  viewMyAssigned.addEventListener('click', ()=>{
    statusFilter.value = '';
    applyFilters();
    filteredBookings = bookings.filter(b => b.assignedTo === currentCleanerId);
    renderBookings(filteredBookings);
  });
  viewPending.addEventListener('click', ()=> { statusFilter.value = 'pending'; applyFilters(); });

  // initial update
  updateSignedIn();
  renderBookings(bookings);
  renderLastCounts();
}

/* update signed in specific fields */
function updateSignedIn(){
  updateSignedInDisplay();
  // refresh bookings view
  applyFilters();
}

function updateSignedInDisplay(){
  const c = cleaners.find(x=>x.id===currentCleanerId);
  if (!c) return;
  signedNameEl.textContent = c.name;
  signedRoleEl.textContent = c.role;
  onlineStatusEl.textContent = c.online ? 'Online' : 'Offline';
  toggleOnlineBtn.textContent = c.online ? 'Go Offline' : 'Go Online';
  hoursInput.value = c.hours || '';
}

/* render counts (summary) */
function renderLastCounts(){
  const countsObj = bookings.reduce((acc,b)=>{
    acc[b.status] = (acc[b.status] || 0) + 1;
    return acc;
  },{});
  // show summary
  const text = `P:${countsObj.pending||0} A:${countsObj.assigned||0} I:${countsObj['in-progress']||0} C:${countsObj.completed||0}`;
  counts.textContent = text;
}

/* run init */
init();
</script>
</body>
</html>
